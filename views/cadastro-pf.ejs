<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Cadastro Pessoa Física</title>
  <link rel="stylesheet" href="/css/signup.css">
</head>
<body>
<%- include('partials/navbar.ejs') %>

<main class="form-etapas-wrapper">
  <% if (mensagemErro) { %>
  <div class="erro-cadastro">
    <p><%= mensagemErro %></p>
  </div>
    <% } %>  
  <h2><u>Cadastro - Pessoa Física</u></h2>

  <form id="form-pf" method="POST" action="/cadastro-pf">
    <details id="etapa-1" open>
        <summary>Etapa 1 - Informações Pessoais</summary>
        <div class="form-row">
          <div class="form-group">
            <label>Nome</label>
            <input type="text" name="nome" required>
          </div>
          <div class="form-group">
            <label>Sobrenome</label>
            <input type="text" name="sobrenome" required>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>CPF</label>
            <input type="text" id="cpf" name="cpf" required>
          </div>
          <div class="form-group">
            <label>Data de Nascimento</label>
            <input type="date" name="data_nascimento" required>
          </div>
        </div>
        <button type="button" onclick="desbloquearEtapaProxima('etapa-1', 'etapa-2')">Continuar</button>
      </details>
      
      <details id="etapa-2">
        <summary>Etapa 2 - Contato e Acesso</summary>
        <div class="form-row">
          <div class="form-group">
            <label>Email</label>
            <input type="email" name="email" required>
          </div>
        <div class="form-group">
        <label>Senha</label>
            <div class="senha-wrapper">
            <input type="password" id="senha" name="senha" placeholder="Digite sua senha" required>
            <img id="icone-senha" src="/images/eye-closed.png" alt="Mostrar senha" onclick="toggleSenha()">
            </div>
        </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Telefone</label>
            <input type="text" name="telefone" required>
          </div>
        </div>
        <button type="button" onclick="desbloquearEtapaProxima('etapa-2', 'etapa-3')">Continuar</button>
        
      </details>
      
      
      <details id="etapa-3">
        <summary>Etapa 3 - Endereço</summary>
        <div class="form-row">
          <div class="form-group">
            <label>Estado</label>
            <select name="estado" required>
                <option value="">Selecione o estado</option>
                <option value="AC">Acre</option>
                <option value="AL">Alagoas</option>
                <option value="AP">Amapá</option>
                <option value="AM">Amazonas</option>
                <option value="BA">Bahia</option>
                <option value="CE">Ceará</option>
                <option value="DF">Distrito Federal</option>
                <option value="ES">Espírito Santo</option>
                <option value="GO">Goiás</option>
                <option value="MA">Maranhão</option>
                <option value="MT">Mato Grosso</option>
                <option value="MS">Mato Grosso do Sul</option>
                <option value="MG">Minas Gerais</option>
                <option value="PA">Pará</option>
                <option value="PB">Paraíba</option>
                <option value="PR">Paraná</option>
                <option value="PE">Pernambuco</option>
                <option value="PI">Piauí</option>
                <option value="RJ">Rio de Janeiro</option>
                <option value="RN">Rio Grande do Norte</option>
                <option value="RS">Rio Grande do Sul</option>
                <option value="RO">Rondônia</option>
                <option value="RR">Roraima</option>
                <option value="SC">Santa Catarina</option>
                <option value="SP">São Paulo</option>
                <option value="SE">Sergipe</option>
                <option value="TO">Tocantins</option>
            </select>
          </div>
          <div class="form-group">
            <label>Cidade</label>
            <input type="text" name="cidade" placeholder="Digite a cidade da sua loja" required>
          </div>
          <div class="form-group">
            <label>CEP</label>
            <input type="text" name="cep" placeholder="Digite o CEP da sua loja" required>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Endereço</label>
            <input type="text" name="endereco" placeholder="Digite o endereço da sua loja" required>
          </div>
          <div class="form-group">
            <label>Número</label>
            <input type="text" name="numero" placeholder="Digite o numero do estabelecimento" required>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Bairro</label>
            <input type="text" name="bairro" placeholder="Digite o bairro da sua loja" required>
          </div>
          <div class="form-group">
            <label>Complemento</label>
            <input type="text" name="complemento" placeholder="Digite um Complemento">
          </div>
        </div>
        <button type="submit">Finalizar Cadastro</button>
      </details>
  </form>
</main>

<%- include('partials/footer.ejs') %>

<script>
 
  function desbloquearEtapaProxima(atual, proxima) {
    const campos = document.querySelectorAll(`#${atual} input:required`);
    let preenchido = true;
    campos.forEach(input => {
      if (!input.value.trim()) preenchido = false;
    });

    // Validação extra para CPF na Etapa 1
    if (atual === 'etapa-1') {
      const cpfInput = document.getElementById('cpf');
      if (!validarCPF(cpfInput.value)) {
        alert('CPF inválido. Verifique e tente novamente.');
        return;
      }
    }

    if (preenchido) {
      document.getElementById(atual).removeAttribute('open');
      document.getElementById(proxima).setAttribute('open', true);
      document.getElementById(proxima).scrollIntoView({ behavior: 'smooth' });
    } else {
      alert('Por favor, preencha todos os campos obrigatórios.');
    }
  }

  function etapaPreenchida(idEtapa) {
    const campos = document.querySelectorAll(`#${idEtapa} input:required`);
    for (let campo of campos) {
      if (!campo.value.trim()) return false;
    }
    return true;
  }

  document.getElementById('etapa-2').addEventListener('toggle', function () {
    if (this.open && !etapaPreenchida('etapa-1')) {
      alert('Por favor, preencha todos os campos da Etapa 1 antes.');
      this.open = false;
    }
  });

  document.getElementById('etapa-3').addEventListener('toggle', function () {
    if (this.open && !etapaPreenchida('etapa-2')) {
      alert('Por favor, preencha todos os campos da Etapa 2 antes.');
      this.open = false;
    }
  });

  const cpfInput = document.getElementById('cpf');
  if (cpfInput) {
    cpfInput.addEventListener('input', function (e) {
      let value = e.target.value.replace(/\D/g, '');
      value = value.replace(/(\d{3})(\d)/, '$1.$2');
      value = value.replace(/(\d{3})(\d)/, '$1.$2');
      value = value.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
      e.target.value = value;
    });
  }

  document.querySelectorAll('input[name="telefone"]').forEach(function (input) {
    input.addEventListener('input', function (e) {
      let value = e.target.value.replace(/\D/g, '');
      if (value.length <= 10) {
        value = value.replace(/(\d{2})(\d{4})(\d{4})/, '($1) $2-$3');
      } else {
        value = value.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
      }
      e.target.value = value;
    });
  });

  document.querySelectorAll('input[name="cep"]').forEach(function (input) {
    input.addEventListener('input', function (e) {
      let value = e.target.value.replace(/\D/g, '');
      value = value.replace(/(\d{5})(\d)/, '$1-$2');
      e.target.value = value.slice(0, 9);
    });
  });
</script>
<script>
  function toggleSenha() {
    const senhaInput = document.getElementById('senha');
    const icone = document.getElementById('icone-senha');

    const senhaVisivel = senhaInput.type === 'text';

    senhaInput.type = senhaVisivel ? 'password' : 'text';
    icone.src = senhaVisivel ? '/images/eye-open.png' : '/images/eye-closed.png';
    icone.alt = senhaVisivel ? 'Mostrar senha' : 'Esconder senha';
  }
</script>
<script>
  function validarCPF(cpf) {
    cpf = cpf.replace(/[^\d]+/g,'');
    if (cpf === '' || cpf.length !== 11) return false;

    let soma = 0, resto;

    for (let i = 1; i <= 9; i++)
      soma += parseInt(cpf.substring(i - 1, i)) * (11 - i);

    resto = (soma * 10) % 11;
    if (resto === 10 || resto === 11) resto = 0;
    if (resto !== parseInt(cpf.substring(9, 10))) return false;

    soma = 0;
    for (let i = 1; i <= 10; i++)
      soma += parseInt(cpf.substring(i - 1, i)) * (12 - i);

    resto = (soma * 10) % 11;
    if (resto === 10 || resto === 11) resto = 0;
    return resto === parseInt(cpf.substring(10, 11));
  }
</script>


</body>
</html>
