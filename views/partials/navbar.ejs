<head>
  <link rel="stylesheet" href="/css/navbar.css">
  <link rel="stylesheet" href="/css/mini-cart.css">
</head>

<nav class="navbar">
  <div class="navbar-top">
    <div class="logo">
      <a href="/"><img src="/images/logo.png" height="60px" width="60px" alt="Logo"></a>
    </div>

    <div class="nav-links">
      <a href="/lojas">Lojas</a>
      <a href="#">Sobre Nós</a>
      <a href="#">Mapa</a>
    </div>

    <form class="search-bar" action="/produtos" method="GET">
      <input type="text" name="pesquisa" placeholder="Buscar produtos..." required>
      <button type="submit">
        <img src="/images/search-icon.png" alt="Buscar" height="20px" width="20px">
      </button>
    </form>

  <div class="nav-links">
  <a href="/">Início</a>

  <% if (usuario) { %>
    <a href="#" id="btn-carrinho">Carrinho</a>
    <div id="mini-cart" class="mini-cart hidden">
      <h3>Seu Carrinho</h3>
      <div id="mini-cart-itens"></div>
      <a href="/checkout"><button class="btn-finalizar">Finalizar Compra</button></a>
    </div>

    <a href="/meus-pedidos">Meus Pedidos</a>

    <% 
      const tipo = (usuario.tipo || '').toLowerCase();
      const iconePadrao = tipo === 'pj' ? '/images/store_logos/store.png' : '/images/user_default.png';
      const temIcone = usuario.icone_url && usuario.icone_url !== 'null' && usuario.icone_url.trim() !== '';
      const iconePerfil = temIcone ? usuario.icone_url : iconePadrao;
      const nomeExibicao = usuario.nome || usuario.username || (tipo === 'pj' ? 'Minha loja' : 'Minha conta');
    %>
    <a href="/meus-chats">Meus Chats</a>
    <div class="loja-dropdown">
      <button class="loja-trigger" id="lojaTrigger" type="button" aria-expanded="false" aria-controls="dropdownMenu">
        <img src="<%= iconePerfil %>" alt="Perfil" class="icone-perfil">
        <span class="nome-usuario"><%= nomeExibicao %></span>
        <span class="caret">▾</span>
      </button>

      <div class="dropdown-conteudo" id="dropdownMenu">
        <% if (tipo === 'pj') { %>
          <a href="/painel/loja">Painel da Loja</a>
          <a href="/loja/<%= usuario.id %>">Ver Loja Pública</a>
          <a href="/cadastro-item">Novo Produto</a>
        <% } else { %>
          <a href="/painel/usuario">Painel do Usuário</a>
          <a href="/usuario/<%= usuario.id %>">Ver Perfil Público</a>
        <% } %>
        <a href="/logout">Sair</a>
      </div>
    </div>
  <% } else { %>
    <a href="/login">Entrar</a>
    <a href="/escolher-cadastro" class="signup">Cadastre-se</a>
  <% } %>
  </div>

</div>
</nav>
<nav class="navbar-2">
  <div class="navbar-bottom">
    <a href="/produtos">Explorar</a>
    <a href="#" id="btn-corda">Instrumentos de Corda</a>
    <a href="#" onclick="alert('Em breve!')">Percussão</a>
    <a href="#" onclick="alert('Em breve!')">Teclados e Pianos</a>
    <a href="#" onclick="alert('Em breve!')">Sopro</a>
    <a href="#" onclick="alert('Em breve!')">Áudio</a>
    <a href="#" onclick="alert('Em breve!')">Acessórios</a>
    <a class="sell-now" href="/cadastro-item">VENDA AGORA!</a>
    <a href="#">Ajuda</a>
    <a href="#">Sobre o Marketplace</a>
  </div>

  <div id="painel-filtro" class="painel-filtro">
    <div class="painel-conteudo">
      <span class="fechar-filtro">&times;</span>
      <a>Instrumentos de Corda</a>
      <div class="grid-categorias">
        <!-- Coluna 1 -->
        <div class="coluna">
          <h3>Guitarras Elétricas</h3>
          <ul>
            <li><a href="/produtos?shape[]=Stratocaster">Stratocaster</a></li>
            <li><a href="/produtos?shape[]=Telecaster">Telecaster</a></li>
            <li><a href="/produtos?shape[]=Les Paul">Les Paul</a></li>
            <li><a href="/produtos?shape[]=SG">SG</a></li>
            <li><a href="/produtos?shape[]=Explorer">Explorer</a></li>
            <li><a href="/produtos?shape[]=Flying V">Flying V</a></li>
          </ul>

          <h3>Baixos</h3>
          <ul>
            <li><a href="/produtos?categoria=baixo4cordas">4 Cordas</a></li>
            <li><a href="/produtos?categoria=baixo5cordas">5 Cordas</a></li>
            <li><a href="/produtos?categoria=ativos">Ativos</a></li>
            <li><a href="/produtos?categoria=passivos">Passivos</a></li>
            <li><a href="/produtos?categoria=canhoto">Canhoto</a></li>
            <li><a href="/produtos?categoria=acustico">Acústico</a></li>
          </ul>
        </div>

        <!-- Coluna 2 -->
        <div class="coluna">
          <h3>Violões</h3>
          <ul>
            <li><a href="/produtos?categoria=classico">Clássico (Nylon)</a></li>
            <li><a href="/produtos?categoria=folk">Folk (Aço)</a></li>
            <li><a href="/produtos?categoria=eletroacustico">Eletroacústico</a></li>
            <li><a href="/produtos?categoria=cutaway">Cutaway</a></li>
            <li><a href="/produtos?categoria=flat">Flat</a></li>
            <li><a href="/produtos?categoria=mini">Mini/Viagem</a></li>
            <li><a href="/produtos?categoria=12cordas">12 Cordas</a></li>
            <li><a href="/produtos?categoria=canhoto">Canhoto</a></li>
            <li><a href="/produtos?categoria=iniciantes">Para Iniciantes</a></li>
          </ul>
        </div>

        <!-- Coluna 3 -->
        <div class="coluna">
          <h3>Acessórios e Peças</h3>
          <ul>
            <li><a href="/produtos?categoria=cordas">Cordas</a></li>
            <li><a href="/produtos?categoria=captadores">Captadores</a></li>
            <li><a href="/produtos?categoria=afinadores">Afinadores</a></li>
            <li><a href="/produtos?categoria=correias">Correias</a></li>
            <li><a href="/produtos?categoria=pedais">Pedais</a></li>
            <li><a href="/produtos?categoria=capotrastes">Capotrastes</a></li>
            <li><a href="/produtos?categoria=ponte">Ponte / Nut</a></li>
            <li><a href="/produtos?categoria=trastes">Trastes</a></li>
            <li><a href="/produtos?categoria=escudos">Escudos</a></li>
            <li><a href="/produtos?categoria=tarraxas">Tarraxas</a></li>
          </ul>
        </div>

        <!-- Coluna 4 -->
        <div class="coluna">
          <h3>Mais Buscados</h3>
          <ul>
            <li><a href="/produtos?categoria=tagima-stratocaster">Tagima Stratocaster</a></li>
            <li><a href="/produtos?categoria=giannini-classico">Giannini Clássico</a></li>
            <li><a href="/produtos?categoria=fender-telecaster">Fender Telecaster</a></li>
            <li><a href="/produtos?categoria=gibson-lespaul">Gibson Les Paul</a></li>
            <li><a href="/produtos?categoria=yamaha-c40">Yamaha C40</a></li>
            <li><a href="/produtos?categoria=tagima-dallas">Tagima Dallas</a></li>
            <li><a href="/produtos?categoria=michael-vm925">Michael VM925</a></li>
            <li><a href="/produtos?categoria=ibanez-rg">Ibanez RG</a></li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</nav>

<script>
  const abrirPainelBtn = document.getElementById("btn-corda");
  const painel = document.getElementById("painel-filtro");
  const fecharBtn = document.querySelector(".fechar-filtro");

  abrirPainelBtn.addEventListener("click", (e) => {
    e.preventDefault();
    painel.classList.toggle("ativo");
  });

  fecharBtn.addEventListener("click", () => {
    painel.classList.remove("ativo");
  });
</script>

<script>
  const trigger  = document.getElementById("lojaTrigger");
  const dropdown = document.getElementById("dropdownMenu");

  if (trigger && dropdown) {
    const open  = () => { dropdown.style.display = "block"; trigger.setAttribute("aria-expanded","true"); };
    const close = () => { dropdown.style.display = "none";  trigger.setAttribute("aria-expanded","false"); };
    const toggle = () => (dropdown.style.display === "block" ? close() : open());

    trigger.addEventListener("click", (e) => {
      e.stopPropagation();
      toggle();
    });

    document.addEventListener("click", (e) => {
      if (!dropdown.contains(e.target) && !trigger.contains(e.target)) {
        close();
      }
    });

    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") close();
    });
  }
</script>

<script>
// Função para atualizar o mini cart sem fechar
async function atualizarMiniCart() {
  const res = await fetch('/api/carrinho');
  const data = await res.json();

  const container = document.getElementById("mini-cart-itens");
  container.innerHTML = ""; // limpa

  if (data.length === 0) {
    container.innerHTML = "<p>Seu carrinho está vazio.</p>";
  } else {
    data.forEach(item => {
      const div = document.createElement("div");
      div.classList.add("mini-cart-item");
      div.innerHTML = `
        <img src="${item.produtos.imagem_url.split(',')[0]}" alt="Produto">
        <div>
          <p>${item.produtos.nome}</p>
          <p>Qtd: 
            <button class="btn-qtd" data-id="${item.id}" data-action="minus">-</button>
            ${item.quantidade}
            <button class="btn-qtd" data-id="${item.id}" data-action="plus">+</button>
          </p>
          <p>R$ ${item.produtos.preco}</p>
        </div>
      `;
      container.appendChild(div);
    });

    // Reatribui os event listeners aos botões + e -
    document.querySelectorAll(".btn-qtd").forEach(btn => {
      btn.addEventListener("click", async (e) => {
        e.stopPropagation(); // impede o fechamento do mini cart
        const id = btn.getAttribute("data-id");
        const action = btn.getAttribute("data-action");
        await fetch(`/api/carrinho/${id}/${action}`, { method: "POST" });
        await atualizarMiniCart(); // atualiza sem fechar
      });
    });
  }
}

// Event listener do botão carrinho para abrir/fechar
document.getElementById("btn-carrinho").addEventListener("click", async (e) => {
  e.preventDefault();
  const miniCart = document.getElementById("mini-cart");

  if (miniCart.classList.contains("hidden")) {
    await atualizarMiniCart(); // carrega itens ao abrir
    miniCart.classList.remove("hidden");
  } else {
    miniCart.classList.add("hidden");
  }
});

// Fechar o mini cart ao clicar fora
document.addEventListener("click", function(event) {
  const miniCart = document.getElementById("mini-cart");
  const btnCarrinho = document.getElementById("btn-carrinho");
  if (!miniCart.contains(event.target) && !btnCarrinho.contains(event.target)) {
    miniCart.classList.add("hidden");
  }
});
</script>
